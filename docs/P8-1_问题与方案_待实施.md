# P8-1 阶段问题诊断与解决方案（待实施）

> **创建时间**: 2026-02-12  
> **来源**: P8-1开发对话总结  
> **状态**: 方案已确认，待下次对话实施  
> **优先级已排序**: P0 > P1 > P2 > P3

---

## 一、本次对话已完成的工作

### 1. 模型修复
- `.env` 中 `DEFAULT_MODEL` 从 `gemini-2-flash` → `gemini-2.0-flash-exp` → **`gemini-2.5-flash`**（最终可用版本）

### 2. 办公室场景实现
- 放弃了 Pixi.js（ESM动态导入在Windows本地开发有CORS问题）
- 改用**原生Canvas 2D API**实现，零外部依赖
- 文件：`frontend/js/office_scene.js`

### 3. 全屏深色极客风UI重构
已完成的前端文件重构：

| 文件 | 改动 |
|------|------|
| `frontend/index.html` | 全新布局：顶栏+全屏Canvas+底部日志+右侧抽屉+老板对话框 |
| `frontend/css/style.css` | 全深色主题(#0d1117)，极客风配色，等宽字体，全屏布局 |
| `frontend/js/office_scene.js` | Canvas2D全屏自适应，Agent间虚线连接，点击Agent事件，选中高亮光圈 |
| `frontend/js/agent_detail_panel.js` | **新建**。右侧滑出抽屉，按Agent归类消息，三个Tab（消息/产出/文件） |
| `frontend/js/app.js` | 完全重写。集成办公室+Agent面板+老板对话框+底部日志，消息按Agent归类存储 |

已**不再使用**的旧模块（文件仍存在但不被import）：
- `frontend/js/chat_panel.js` — 被底部日志栏替代
- `frontend/js/status_panel.js` — 被顶栏状态信息替代
- `frontend/js/file_browser.js` — 被Agent详情面板的"文件"Tab替代
- `frontend/js/boss_panel.js` — 被新的老板对话框替代
- `frontend/js/office_view.js` — 被Canvas2D的office_scene.js替代
- `frontend/js/agent_sprite.js` — 合并到office_scene.js
- `frontend/js/message_bubble.js` — 合并到office_scene.js

### 4. 新UI布局说明

```
┌─ topbar ────────────────────────────────────────────┐
│ ▶ AIGameDev │ PROJECT_NAME │ PHASE │ ██░░ 35% │ ●ON │
├─ workspace (全屏Canvas办公室) ──────────────────────┤
│                                                      │
│   👨‍💼 PM(240,220)        📋 策划(960,220)              │
│       ── 虚线连接 ──                                  │
│   👨‍💻 程序员(240,480)     🎨 美术(960,480)              │
│              🧪 测试(600,580)                         │
│                                                      │
│   点击Agent → 右侧滑出详情面板                         │
│   选中Agent → 彩色光圈高亮                              │
├─ logbar (底部日志栏，140px高) ───────────────────────┤
│ 14:06:51 [agent] PM → 策划: 开始制定GDD…              │
│ 14:06:52 [phase] 阶段切换 → 策划                       │
│ 14:07:01 [boss]  需要老板决策: 确认方向？               │
└─────────────────────────────────────────────────────┘

右侧Agent抽屉（420px宽）:              右下角老板对话框（360px宽）:
┌────────────────────┐                  ┌────────────────┐
│ 👨‍💻 程序员  WORKING  │                  │ 👔 老板通道     │
│ [消息] [产出] [文件] │                  │ PM: 需要您决策  │
│ ────────────────── │                  │ [选项A] [选项B] │
│ PM→程序员: 请编写…  │                  │ 老板: 我选A     │
│ 程序员→PM: 已完成…  │                  └────────────────┘
└────────────────────┘
```

---

## 二、6个待解决问题与方案

### 问题#3（P0优先级）：决策机制没有真正打通

**现象**: PM Agent在消息中提到"需要老板决策"，但实际工作流自动跳到下一阶段，老板没收到任何决策请求。

**根因**: `game_dev_workflow.py` 中 `_request_boss_decision()` 方法（第1093行）已定义好，但工作流的7个阶段处理器里**一次都没有调用过它**。每个阶段都是线性执行，没有决策卡点。

**修复方案**: 在工作流关键节点插入 `await self._request_boss_decision(...)` 调用：

```python
# 示例：在 _phase_1_initiation 末尾
decision = await self._request_boss_decision(
    title="项目立项确认",
    question=f"PM已分析需求并拆解任务，是否确认项目方向？\n\n需求: {self.project_description}",
    options=["确认，开始策划", "修改需求", "取消项目"]
)
if decision == "取消项目":
    raise Exception("老板取消了项目")
elif decision == "修改需求":
    # TODO: 重新走立项流程
    pass
```

**建议的4个决策点**:

| 节点 | 时机 | 决策内容 | 选项 |
|------|------|---------|------|
| 立项确认 | phase1结束 | PM分析完需求后 | 确认/修改需求/取消 |
| 策划审批 | phase2结束 | 策划文档完成后 | 批准/需要修改 |
| 开发验收 | phase4结束 | 代码生成完成后 | 进入测试/先让我看看 |
| 交付确认 | phase6.5结束 | 测试修复完成后 | 交付/继续修复/放弃 |

**涉及文件**: `backend/workflows/game_dev_workflow.py`

---

### 问题#2（P0优先级）：缺少老板决策面板

**现象**: 界面上没有显眼的决策入口。

**现状**: 新UI已经在右下角实现了"老板通道"对话框（`boss-chat`），但因为问题#3，后端从不发送 `boss_decision` 事件，所以面板一直是空的。

**修复方案**: A+B结合
- **A**: 在顶栏加显眼的决策指示灯，有待决策时红色闪烁
- **B**: 有决策时弹出醒目的模态弹窗，老板必须选择才能继续（复用现有BossPanel的shake动画逻辑）

**实现要点**:
- 修复问题#3后，`boss_decision` 事件会正常推送到前端
- 前端 `app.js` 中的 `showBossDecision(data)` 方法已经实现了接收和展示逻辑
- 需要增加：顶栏指示灯 + 模态弹窗模式

**涉及文件**: `frontend/js/app.js`, `frontend/index.html`, `frontend/css/style.css`

---

### 问题#5（P1优先级）：游戏做完有Bug，没有反馈入口

**现象**: 老板试玩游戏发现Bug，无法反馈给AI团队修复。

**方案**: 新增"试玩+反馈"闭环

1. **前端新增**:
   - 交付阶段后显示"试玩游戏"按钮（打开 `output/index.html`）
   - "提交反馈"按钮 → 弹出反馈表单（Bug描述 + 严重程度）
   
2. **后端新增**:
   - `POST /api/project/{id}/feedback` 接口
   - 接受Bug描述，写入 `bug_tracker.yaml`
   - 触发新一轮Bug修复流程（复用 `_phase_6_5_bug_fixing`）
   - 修复后通知老板重新试玩

3. **工作流改造**:
   - 交付阶段不再直接结束工作流
   - 改为等待老板"试玩确认"或"提交反馈"
   - 如果提交反馈 → 重新进入Bug修复循环
   - 老板确认"验收通过" → 工作流结束

**涉及文件**: 
- 新增 `backend/api/http_routes.py` 中的feedback接口
- 修改 `backend/workflows/game_dev_workflow.py` 的交付阶段
- `frontend/js/app.js` 增加试玩和反馈UI

---

### 问题#4（P1优先级）：Agent产出的文本内容看不到

**现象**: Agent实际生成了文件（GDD、技术文档等），但前端"产出"Tab是空的。

**根因**: 
- 后端工作流在生成文件后没有广播 `file_output` 事件
- 前端 `AgentDetailPanel.outputStore` 无数据来源

**方案**:

1. **后端**: 工作流每次调用 `file_tool.write()` 保存文档后，额外广播事件：
```python
await broadcast_agent_output(
    project_id=self.project_name,
    agent_id="planner",  # 产出者
    file_path="shared_knowledge/game_design_doc.md",
    file_type="document",
    summary="游戏策划文档(GDD)已完成"
)
```

2. **后端新增API**: `GET /api/project/{id}/file?path=xxx` 返回文件内容

3. **前端**: 收到 `file_output` 事件后：
   - 在Agent详情面板"产出"Tab展示文件列表
   - 点击可查看完整内容（通过API获取）
   - 支持Markdown简单渲染

**涉及文件**:
- `backend/workflows/game_dev_workflow.py` — 每个阶段文件写入后广播
- `backend/api/websocket_handler.py` — 新增 `broadcast_agent_output` 函数
- `backend/api/http_routes.py` — 新增文件读取API
- `frontend/js/agent_detail_panel.js` — 处理产出事件和展示
- `frontend/js/app.js` — 监听 `file_output` 事件

---

### 问题#1（P2优先级）：查看知识库/接口/配置表/任务状态

**现象**: 没有地方查看Agent们产出的共享知识库文件。

**已有基础**: 后端已在 `shared_knowledge/` 目录生成了完整的文件集：
```
shared_knowledge/
├── project_rules.yaml      # 项目规范
├── game_design_doc.md       # 策划文档(GDD)
├── tech_design_doc.md       # 技术设计文档
├── api_registry.yaml        # 接口注册表（程序员维护）
├── config_tables.yaml       # 配置表（策划维护）
├── art_asset_list.yaml      # 美术素材清单
├── bug_tracker.yaml         # Bug追踪器
└── decision_log.yaml        # 决策日志
```

**方案**: 配合问题#4一起实现
- Agent详情面板的"文件"Tab展示该Agent相关的文件
- 新增一个全局"知识库"入口（可以在顶栏或办公室场景中），展示所有共享文件
- 通过 `GET /api/project/{id}/files` 获取文件列表
- 点击文件展示内容

**涉及文件**: 和问题#4相同

---

### 问题#6（P3优先级）：办公室做成"无限画布"

**现象**: 当前Canvas是固定逻辑尺寸（1200x700）。

**方案**: 添加Camera系统

1. **平移（Pan）**: 鼠标中键拖拽或按住空格+左键拖拽移动视角
2. **缩放（Zoom）**: 滚轮缩放，范围限制 0.3x ~ 3x
3. **Camera变换**:
```javascript
// 在 render() 中
ctx.save();
ctx.translate(this.offsetX, this.offsetY);
ctx.scale(this.scale, this.scale);
// 额外叠加camera
ctx.translate(this.camX, this.camY);
ctx.scale(this.zoom, this.zoom);
// ... 绘制所有元素 ...
ctx.restore();
```

4. **MiniMap**: 右下角小地图，显示当前视口位置
5. **未来扩展**: 画布上可放更多元素（知识库节点、文件节点、决策时间线等）

**涉及文件**: `frontend/js/office_scene.js`

---

## 三、实施优先级总览

| 优先级 | 问题 | 改动范围 | 预计工作量 |
|--------|------|---------|-----------|
| **P0** | #3 决策机制打通 | 后端workflow | 中 |
| **P0** | #2 老板决策面板增强 | 前端 | 小（后端修好后自动生效） |
| **P1** | #5 试玩Bug反馈入口 | 前端+后端API+workflow | 大 |
| **P1** | #4 Agent产出可见 | 前端+后端事件+API | 中 |
| **P2** | #1 知识库浏览 | 前端+后端API | 中（和#4共享） |
| **P3** | #6 无限画布 | 前端Canvas | 中 |

**建议实施顺序**: #3 → #2 → #4+#1 → #5 → #6

---

## 四、下次对话时的上下文指引

### 新对话必读文件
1. **本文档** `docs/P8-1_问题与方案_待实施.md` — 了解要做什么
2. **`docs/platform_constitution.md`** — 了解已完成的架构
3. **`backend/workflows/game_dev_workflow.py`** — 核心工作流（需要改动最多的文件）
4. **`backend/api/websocket_handler.py`** — WebSocket事件推送（需要新增事件）
5. **`frontend/js/app.js`** — 前端主入口（需要增加新事件监听）

### 当前服务器配置
- **模型**: `gemini-2.5-flash`（已在`.env`中配置）
- **端口**: `localhost:8000`
- **前端**: 全深色极客风Canvas2D界面

### 关键代码位置
- 决策方法已实现: `game_dev_workflow.py` 第1093行 `_request_boss_decision()`
- 决策提交处理: `websocket_handler.py` 第289行 `boss_decision_response`
- 工作流注册: `websocket_handler.py` 第320行 `register_workflow()`
- 前端决策展示: `app.js` 中 `showBossDecision(data)` 方法
- Agent详情面板: `agent_detail_panel.js` 中 `addMessage()` 和 `addOutput()`

### 注意事项
- Python导入规范：backend目录内禁止用 `from backend.xxx`，直接用 `from utils.xxx`
- 前端不使用Pixi.js，全部用原生Canvas 2D
- WebSocket URL: `ws://localhost:8000/ws/{client_id}`
- 所有消息事件类型：`agent_message`, `agent_status`, `phase_change`, `boss_decision`, `file_update`, `task_complete`, `error_alert`

---

**文档版本**: v1.0  
**最后更新**: 2026-02-12  
**下次对话**: 按优先级从P0开始实施
