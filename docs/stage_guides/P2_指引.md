# P2 阶段开发指引 - 消息总线 + 多Agent协作

> **阶段名称**: P2 - 消息总线 + 多Agent协作  
> **预计复杂度**: 高  
> **文档级别**: 已完成（参考用）  
> **使用说明**: 本指引为已完成阶段的精简版，供查阅和参考

---

## 🎯 阶段目标

实现多个Agent之间的自由通信和协作：
1. **消息总线** - 所有Agent通信的中枢，负责消息路由和记录
2. **5个具体Agent** - PM、策划、程序员、美术、测试
3. **Agent工作循环** - 每个Agent能主动检查消息、处理任务
4. **自由对话机制** - Agent能在任何时候找任何其他Agent沟通

---

## 📋 核心任务清单

### 已完成的功能

#### 前置任务（优先完成）
- [x] **工具模块** (`backend/utils/`)
  - `logger.py` - 统一日志系统（146行）
  - `retry.py` - 重试装饰器（89行）
  - 更新P1模块集成日志和重试

#### 核心组件
- [x] **消息总线** (`backend/engine/message_bus.py` - 472行)
  - 单例模式
  - 消息路由（点对点、广播、发给老板）
  - 消息队列管理
  - 消息历史记录（最近1000条）
  - 频率限制（防止消息循环）
  - WebSocket推送接口（预留）

- [x] **Agent管理器** (`backend/engine/agent_manager.py`)
  - 管理所有Agent实例
  - Agent工作循环调度
  - 消息分发

- [x] **5个具体Agent** (`backend/agents/`)
  - `pm_agent.py` - 项目经理
  - `planner_agent.py` - 游戏策划
  - `programmer_agent.py` - 游戏程序员
  - `artist_agent.py` - 美术设计师
  - `tester_agent.py` - 测试工程师

---

## 🔗 核心接口

### MessageBus（单例）
```python
class MessageBus:
    def subscribe(agent_id: str, callback: Callable) -> None
    async def send(message: Dict) -> bool
    async def receive(agent_id: str, timeout: float = 1.0) -> Optional[Dict]
    def get_history(limit: int = 100, agent_id: str = None) -> List[Dict]
    def get_summary() -> Dict
```

### 消息格式标准
```json
{
    "from": "agent_id",
    "to": "target_id",
    "type": "question|answer|report|request_review",
    "content": "消息正文",
    "context": "工作上下文",
    "priority": "normal|urgent|blocking",
    "timestamp": "ISO8601时间戳"
}
```

### AgentManager
```python
class AgentManager:
    def register_agent(agent: Agent) -> None
    async def start_all() -> None
    async def stop_all() -> None
    def get_agent(agent_id: str) -> Optional[Agent]
```

---

## ✅ 验证标准

### 功能验证
- [x] PM能给策划发消息
- [x] 策划能收到并回复
- [x] 程序员能找策划提问
- [x] 消息频率限制生效
- [x] 消息历史正确记录

### 测试结果
- ✅ 所有测试通过
- ✅ Agent间通信流畅
- ✅ 消息路由正确

---

## 🛠️ 使用的Skills

- `async-python-patterns` - 异步消息处理
- `python-design-patterns` - 消息总线架构（观察者模式）
- `message-queues` - 消息队列设计
- `logging-best-practices` - 消息日志
- `python-testing-patterns` - 消息路由测试

---

## 📐 关键技术点

### 1. 单例消息总线
```python
class MessageBus:
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance._initialized = False
        return cls._instance
```

### 2. 消息路由规则
```python
async def send(self, message: Dict) -> bool:
    to = message.get("to")
    
    if to == "all":
        # 广播给所有Agent
        await self._broadcast(message)
    elif to == "boss":
        # 发给老板（触发前端弹窗）
        await self._send_to_boss(message)
    else:
        # 点对点发送
        await self._send_to_agent(to, message)
```

### 3. Agent工作循环
```python
async def agent_work_loop(agent):
    while True:
        # 1. 检查消息
        message = await message_bus.receive(agent.agent_id)
        if message:
            response = await agent.process_message(message)
            if response:
                await message_bus.send(response)
            continue
        
        # 2. 检查任务（P4实现）
        # ...
        
        # 3. 空闲等待
        await asyncio.sleep(2)
```

### 4. 消息频率限制
```python
# 同一对Agent之间1分钟内最多10条消息
if self._check_rate_limit(from_id, to_id):
    logger.warning(f"消息频率超限: {from_id} -> {to_id}")
    return False
```

---

## 📝 已生成的文档

- `docs/P2前置任务完成报告.md` (441行) - 日志和重试实施
- `docs/P2阶段完成报告.md` (478行) - 消息总线和Agent实现

---

## 🚀 下一阶段

**P3阶段**: 工具系统

**P2为P3准备的**:
- 消息总线可以传递工具调用请求
- Agent基类可以扩展工具调用能力
- 5个Agent定义可以配置工具权限

---

**指引版本**: v1.0  
**创建日期**: 2026-02-11  
**状态**: ✅ 已完成  
**实际工作量**: 包含前置任务约15轮对话
