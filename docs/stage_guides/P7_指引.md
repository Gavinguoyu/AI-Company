# P7 阶段开发指引 - 人类介入机制

> **阶段名称**: P7 - 人类介入机制  
> **预计复杂度**: 低  
> **文档级别**: Level 1 (只更新constitution，不生成独立报告)  
> **使用说明**: AI开始P7开发时，只需阅读本文档 + platform_constitution.md

---

## 🎯 阶段目标

实现老板（用户）与AI Agent的双向交互机制：
1. **Agent请求决策** - 当遇到分歧或关键节点时，Agent能向老板请求决策
2. **前端弹窗** - 前端显示决策请求，提供选择按钮或输入框
3. **决策回传** - 用户的决策通过WebSocket回传给后端，Agent继续工作

这是用户从"观察者"变为"决策者"的关键功能。

---

## 📋 核心任务清单

### 必须完成的功能

- [ ] **后端决策等待机制** (`backend/workflows/game_dev_workflow.py` 或新文件)
  - Agent能发送`boss_decision`类型的消息
  - 工作流暂停，等待决策返回
  - 收到决策后继续执行

- [ ] **前端决策面板** (`frontend/js/boss_panel.js`)
  - 监听`boss_decision`事件
  - 弹出模态窗口显示决策请求
  - 提供按钮（是/否/选择A/选择B）或输入框
  - 点击后通过WebSocket发送决策

- [ ] **WebSocket双向通信扩展** 
  - 前端能发送消息到后端（之前只接收）
  - 后端处理前端发来的决策消息

### 可选功能（时间充裕时）
- [ ] 决策历史记录（在前端显示过往决策）
- [ ] 决策超时机制（30秒未响应则自动选择默认值）

---

## 🔗 前置依赖

### P6阶段已提供的前端框架

**已实现的模块**:
- `WebSocketClient` - WebSocket客户端（只需扩展发送功能）
- 前端布局框架（可在其上添加决策面板）

**可以直接使用**:
- WebSocket连接已建立
- 前端能接收`boss_decision`事件（P6已预留）

**需要扩展的部分**:
- WebSocket客户端添加`send(message)`方法
- 新增决策面板模块

### P5阶段已提供的后端接口

**已实现**:
- `POST /api/boss/decision` - 提交决策的HTTP接口
- WebSocket消息广播机制

**需要扩展的部分**:
- 工作流中添加"暂停等待决策"逻辑
- WebSocket接收前端消息的处理

---

## ✅ 验证标准

### 功能验证
- [ ] Agent能发送决策请求
- [ ] 前端能弹出决策面板
- [ ] 用户点击后决策能回传到后端
- [ ] Agent收到决策后继续工作

### 集成验证
- [ ] 不影响P6的其他功能
- [ ] 决策面板样式与整体界面一致

### 简单测试
- [ ] 手动触发一个决策请求（测试模式）
- [ ] 前端正确显示
- [ ] 点击后后端日志显示收到决策

---

## 🛠️ 推荐使用的Skills

- `websocket-engineer` - WebSocket双向通信
- `modern-javascript-patterns` - 前端模态框实现
- `async-python-patterns` - 后端异步等待机制

---

## 📐 技术要点

### 关键技术点1: 后端暂停等待决策

```python
# 在工作流中
async def _phase_2_planning(self):
    # 策划完成GDD
    gdd = await self.planner.create_gdd()
    
    # 请求老板审批
    decision = await self._request_boss_decision(
        title="策划文档审批",
        question="策划已完成游戏设计文档，请审批：",
        options=["通过", "修改", "重新设计"],
        context={"gdd_summary": gdd[:200]}
    )
    
    if decision == "通过":
        # 继续下一阶段
        await self._phase_3_tech_design()
    elif decision == "修改":
        # 返回修改
        pass
```

```python
async def _request_boss_decision(self, title, question, options, context):
    """请求老板决策，阻塞等待"""
    decision_id = str(uuid.uuid4())
    
    # 通过WebSocket发送决策请求
    await self.websocket_manager.broadcast({
        "event": "boss_decision",
        "data": {
            "id": decision_id,
            "title": title,
            "question": question,
            "options": options,
            "context": context
        }
    })
    
    # 等待决策（异步等待，不阻塞其他协程）
    decision = await self._wait_for_decision(decision_id, timeout=300)
    return decision
```

### 关键技术点2: 前端决策面板

```javascript
// boss_panel.js
export class BossPanel {
    constructor(container, wsClient) {
        this.container = container;
        this.wsClient = wsClient;
        this.currentDecision = null;
        
        // 监听决策请求
        wsClient.on('boss_decision', (data) => this.showDecision(data));
    }
    
    showDecision(data) {
        this.currentDecision = data;
        
        // 创建模态窗口
        const modal = this.createModal(data);
        document.body.appendChild(modal);
    }
    
    createModal(data) {
        const modal = document.createElement('div');
        modal.className = 'modal boss-decision';
        modal.innerHTML = `
            <div class="modal-content">
                <h2>${data.title}</h2>
                <p>${data.question}</p>
                <div class="options">
                    ${data.options.map((opt, i) => 
                        `<button data-option="${opt}">${opt}</button>`
                    ).join('')}
                </div>
            </div>
        `;
        
        // 绑定点击事件
        modal.querySelectorAll('button').forEach(btn => {
            btn.onclick = () => this.submitDecision(data.id, btn.dataset.option);
        });
        
        return modal;
    }
    
    submitDecision(decisionId, choice) {
        // 通过WebSocket发送决策
        this.wsClient.send({
            type: 'boss_decision_response',
            decision_id: decisionId,
            choice: choice
        });
        
        // 关闭模态窗口
        document.querySelector('.modal.boss-decision').remove();
    }
}
```

### 关键技术点3: WebSocket双向通信

```javascript
// websocket.js - 添加send方法
class WebSocketClient {
    // ... existing code ...
    
    send(message) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify(message));
        } else {
            console.error('WebSocket未连接，无法发送消息');
        }
    }
}
```

```python
# backend/api/websocket_handler.py - 接收消息
@router.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await manager.connect(client_id, websocket)
    try:
        while True:
            # 接收前端消息
            data = await websocket.receive_text()
            message = json.loads(data)
            
            # 处理决策响应
            if message.get('type') == 'boss_decision_response':
                await handle_boss_decision(message)
    except WebSocketDisconnect:
        manager.disconnect(client_id)
```

---

## 🧪 测试方案（自动执行）

### Step 1: 快速回归测试
```bash
python tests/run_regression.py
```

### Step 2: 简单功能测试
由于P7功能简单，可以手动测试：
1. 修改工作流代码，在某个阶段强制触发决策请求
2. 启动后端，打开前端
3. 触发决策流程，验证弹窗
4. 点击选项，查看后端日志

### Step 3: 记录结果
只更新constitution，不生成独立报告

---

## 📝 完成后的文档工作（自动执行）

### 1. 更新 platform_constitution.md（必做）
在P7章节简要记录：
```markdown
## P7: 人类介入机制

> 状态: ✅ 已完成 (日期)

### 核心实现
- 后端决策等待机制 (`workflows/` 或 `api/`)
- 前端决策面板 (`frontend/js/boss_panel.js`)
- WebSocket双向通信扩展

### 关键接口
```python
async def _request_boss_decision(title, question, options, context) -> str
```

### 测试验证
✅ 决策请求能正常发送
✅ 前端弹窗显示正确
✅ 决策能回传到后端

### 下一阶段集成点
P8联调测试时，可以测试完整的决策流程
```

### 2. 不生成独立阶段报告
P7功能相对简单，信息都记录在constitution中即可

---

## 🚀 下一阶段预告

**P8阶段将实现**: 端到端联调测试

**本阶段需要为P8准备**:
- 决策机制能在完整工作流中正常工作
- P8会测试：发起项目 → Agent工作 → 请求决策 → 继续工作 → 完成项目

---

## 💡 开发提示

### 时间分配建议
- 后端决策机制: 40%
- 前端决策面板: 40%
- 测试和调试: 20%

### 实现优先级
1. 先实现最简单的决策流程（一个问题，两个按钮）
2. 验证能正常工作后，再扩展更复杂的决策类型

### 常见问题FAQ

**Q: 决策超时怎么办？**
A: 第一版可以不处理超时，P10优化时再添加。

**Q: 是否需要保存决策历史？**
A: 暂不需要，P10优化时可添加。

**Q: 决策面板样式如何？**
A: 简单清晰即可，不要求精美，P10优化。

---

**指引版本**: v1.0  
**最后更新**: 2026-02-11  
**预计工作量**: 4-6轮对话
