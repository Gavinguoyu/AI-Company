# P8-1 阶段开发指引 - 2D像素风办公室（必需功能）

> **阶段名称**: P8-1 - 2D像素风办公室可视化（第1阶段）  
> **预计复杂度**: 高  
> **文档级别**: Level 2 (精简报告)  
> **美术风格**: 像素风（Pixel Art）  
> **使用说明**: AI开始P8-1开发时，只需阅读本文档 + platform_constitution.md

---

## 🎯 阶段目标

在P6和P7完成后，Agent们已经能真正产出游戏并接受人类决策。现在是时候让用户**看到**这一切是如何发生的！

**核心目标**: 构建一个2D像素风的虚拟办公室，让用户能：
1. **实时观看** 5个AI Agent在"办公室"中的工作状态
2. **看到对话** Agent之间的消息以对话气泡形式显示
3. **监控进度** 当前项目的开发进度和阶段
4. **查看输出** 生成的游戏文件

**视觉风格**: 像素风（类似《Game Dev Tycoon》、《Stardew Valley》）
- 简洁、复古、可爱
- 16x16或32x32像素的Agent精灵
- 简化的办公室场景

**P8-1只实现必需功能，P8-2实现增强功能。**

---

## 📋 核心任务清单（P8-1必需功能）

### 必须完成的功能

#### 任务1: Pixi.js场景初始化
- [ ] 创建 `frontend/js/office_scene.js`
- [ ] 初始化Pixi.js应用（800x600像素）
- [ ] 创建办公室背景（纯色或简单纹理）
- [ ] 定义5个Agent的工位坐标

#### 任务2: Agent精灵系统
- [ ] 创建 `frontend/js/agent_sprite.js`
- [ ] 使用Emoji或简单像素图作为Agent头像
  - PM: 👨‍💼 或像素西装人
  - 策划: 📋 或像素笔记本
  - 程序员: 👨‍💻 或像素电脑
  - 美术: 🎨 或像素画板
  - 测试: 🧪 或像素bug
- [ ] Agent名牌显示（名字+角色）
- [ ] Agent状态颜色指示：
  - 灰色 = 空闲 (idle)
  - 蓝色 = 工作中 (working)
  - 绿色 = 对话中 (communicating)
  - 红色 = 错误 (error)

#### 任务3: 对话气泡系统
- [ ] 创建 `frontend/js/message_bubble.js`
- [ ] 头顶气泡显示：
  - 状态气泡（常驻，半透明）
  - 对话气泡（临时，3-5秒后消失）
- [ ] 消息飞行动画：
  - 简单的直线飞行（从A到B）
  - 或贝塞尔曲线飞行（更流畅）
- [ ] 点击气泡可固定查看

#### 任务4: 聊天记录窗口
- [ ] 创建 `frontend/js/chat_log.js`
- [ ] 固定在右侧的消息历史面板
- [ ] 显示所有Agent消息（发送者、接收者、内容、时间）
- [ ] 自动滚动到最新消息
- [ ] 可筛选（按Agent）

#### 任务5: 项目状态面板
- [ ] 创建 `frontend/js/status_panel.js`
- [ ] 显示：
  - 当前项目名称
  - 当前开发阶段（1-7）
  - 进度百分比
  - Token使用量（可选）
- [ ] 位置：顶部或左上角

#### 任务6: WebSocket集成
- [ ] 连接P5的WebSocket服务
- [ ] 监听事件：
  - `agent_status` → 更新Agent状态（颜色变化）
  - `agent_message` → 显示消息飞行动画+气泡
  - `phase_change` → 更新项目状态面板
- [ ] 实时同步

#### 任务7: 主页面布局
- [ ] 修改 `frontend/index.html`
- [ ] 布局：
  ```
  ┌─────────────────────────────────────┐
  │  [项目状态面板]                      │
  ├──────────────────┬──────────────────┤
  │                  │                  │
  │  办公室Canvas     │   聊天记录窗口   │
  │  (Pixi.js)       │   (滚动列表)     │
  │  800x600         │   400x600        │
  │                  │                  │
  └──────────────────┴──────────────────┘
  ```
- [ ] 引入Pixi.js CDN（v7.x）
- [ ] 引入所有JS模块

---

## 🔗 前置依赖

### P5阶段的WebSocket

**已实现**:
- WebSocket服务器 `ws://localhost:8000/ws`
- 事件推送：`agent_message`, `agent_status`, `phase_change`

**可以直接使用**

### P6阶段的游戏生成

**已实现**:
- Agent能真正产出游戏文件
- `projects/{项目名}/output/` 有可玩的游戏

**P8-1将可视化这个过程**

### P7阶段的决策机制

**已实现**:
- 决策请求会通过`boss_decision`事件推送

**P8-1将显示决策弹窗（如果有）**

---

## ✅ 验证标准

### 功能验证
- [ ] 浏览器打开 `http://localhost:8000/` 能看到办公室场景
- [ ] 能看到5个Agent精灵在各自工位
- [ ] Agent状态变化时颜色改变
- [ ] 消息发送时能看到飞行动画
- [ ] 聊天窗口能显示所有消息
- [ ] 状态面板能显示项目信息

### 视觉效果验证
- [ ] 像素风格一致
- [ ] 动画流畅（60fps）
- [ ] 颜色搭配合理
- [ ] 文字清晰可读

### 性能验证
- [ ] 页面加载时间 < 3秒
- [ ] 多个动画同时播放不卡顿
- [ ] 长时间运行无内存泄漏

---

## 🛠️ 推荐使用的Skills

- `modern-javascript-patterns` - ES6+模块化
- `websocket-engineer` - WebSocket实时通信
- `web-design-guidelines` - UI/UX设计
- `javascript-testing-patterns` - 前端测试（可选）

---

## 📐 技术要点

### 关键技术点1: Pixi.js初始化

```javascript
// office_scene.js
import * as PIXI from 'https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.min.mjs';

export class OfficeScene {
    constructor(container) {
        // 创建Pixi应用
        this.app = new PIXI.Application({
            width: 800,
            height: 600,
            backgroundColor: 0x34495e,  // 深灰色背景
            antialias: true
        });
        
        container.appendChild(this.app.view);
        
        // 创建场景容器
        this.officeContainer = new PIXI.Container();
        this.app.stage.addChild(this.officeContainer);
        
        // 创建Agent
        this.agents = new Map();
        this.createAgents();
    }
    
    createAgents() {
        const positions = {
            'pm': { x: 150, y: 150 },
            'planner': { x: 550, y: 150 },
            'programmer': { x: 150, y: 350 },
            'artist': { x: 550, y: 350 },
            'tester': { x: 350, y: 450 }
        };
        
        for (const [id, pos] of Object.entries(positions)) {
            const agent = new AgentSprite(id, pos.x, pos.y);
            this.agents.set(id, agent);
            this.officeContainer.addChild(agent.container);
        }
    }
}
```

### 关键技术点2: Agent精灵（使用Emoji）

```javascript
// agent_sprite.js
export class AgentSprite {
    constructor(agentId, x, y) {
        this.agentId = agentId;
        this.container = new PIXI.Container();
        this.container.position.set(x, y);
        
        // 创建Agent头像（使用Text作为Emoji）
        const emojis = {
            'pm': '👨‍💼',
            'planner': '📋',
            'programmer': '👨‍💻',
            'artist': '🎨',
            'tester': '🧪'
        };
        
        this.avatar = new PIXI.Text(emojis[agentId] || '😊', {
            fontSize: 48,
            fontFamily: 'Arial'
        });
        this.avatar.anchor.set(0.5);
        this.container.addChild(this.avatar);
        
        // 名牌
        const names = {
            'pm': 'PM',
            'planner': '策划',
            'programmer': '程序员',
            'artist': '美术',
            'tester': '测试'
        };
        
        this.nameText = new PIXI.Text(names[agentId], {
            fontSize: 14,
            fill: 0xffffff
        });
        this.nameText.anchor.set(0.5);
        this.nameText.position.y = 40;
        this.container.addChild(this.nameText);
        
        // 状态指示圆圈
        this.statusCircle = new PIXI.Graphics();
        this.updateStatus('idle');
        this.statusCircle.position.y = -30;
        this.container.addChild(this.statusCircle);
    }
    
    updateStatus(status) {
        const colors = {
            'idle': 0x95a5a6,      // 灰色
            'working': 0x3498db,    // 蓝色
            'communicating': 0x2ecc71,  // 绿色
            'error': 0xe74c3c       // 红色
        };
        
        this.statusCircle.clear();
        this.statusCircle.beginFill(colors[status] || colors.idle);
        this.statusCircle.drawCircle(0, 0, 8);
        this.statusCircle.endFill();
    }
}
```

### 关键技术点3: 消息飞行动画

```javascript
// message_bubble.js
export class MessageBubble {
    static flyMessage(scene, fromAgent, toAgent, content) {
        const fromPos = scene.agents.get(fromAgent).container.position;
        const toPos = scene.agents.get(toAgent).container.position;
        
        // 创建消息图标（简单的圆圈）
        const message = new PIXI.Graphics();
        message.beginFill(0xf39c12);  // 橙色
        message.drawCircle(0, 0, 10);
        message.endFill();
        message.position.set(fromPos.x, fromPos.y);
        
        scene.officeContainer.addChild(message);
        
        // 动画飞行（1秒）
        const startTime = Date.now();
        const duration = 1000;
        
        const animate = () => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // 线性插值
            message.x = fromPos.x + (toPos.x - fromPos.x) * progress;
            message.y = fromPos.y + (toPos.y - fromPos.y) * progress;
            
            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                // 到达后显示气泡，移除消息图标
                scene.officeContainer.removeChild(message);
                MessageBubble.showBubble(scene, toAgent, content);
            }
        };
        
        animate();
    }
    
    static showBubble(scene, agentId, content) {
        const agent = scene.agents.get(agentId);
        
        // 创建气泡文字
        const bubble = new PIXI.Text(content.substring(0, 20) + '...', {
            fontSize: 12,
            fill: 0xffffff,
            backgroundColor: '#000000aa',
            padding: 5
        });
        bubble.anchor.set(0.5);
        bubble.position.y = -60;
        agent.container.addChild(bubble);
        
        // 3秒后移除
        setTimeout(() => {
            agent.container.removeChild(bubble);
        }, 3000);
    }
}
```

### 关键技术点4: WebSocket集成

```javascript
// app.js - 主入口
import { OfficeScene } from './office_scene.js';
import { ChatLog } from './chat_log.js';
import { StatusPanel } from './status_panel.js';

// 连接WebSocket
const ws = new WebSocket('ws://localhost:8000/ws');

// 创建场景
const officeCanvas = document.getElementById('office-canvas');
const officeScene = new OfficeScene(officeCanvas);

const chatLog = new ChatLog(document.getElementById('chat-log'));
const statusPanel = new StatusPanel(document.getElementById('status-panel'));

// 监听消息
ws.onmessage = (event) => {
    const message = JSON.parse(event.data);
    
    switch(message.event) {
        case 'agent_status':
            // 更新Agent状态
            const agent = officeScene.agents.get(message.data.agent_id);
            if (agent) {
                agent.updateStatus(message.data.status);
            }
            break;
            
        case 'agent_message':
            // 显示消息飞行
            MessageBubble.flyMessage(
                officeScene,
                message.data.from,
                message.data.to,
                message.data.content
            );
            // 同时记录到聊天窗口
            chatLog.addMessage(message.data);
            break;
            
        case 'phase_change':
            // 更新状态面板
            statusPanel.updatePhase(message.data.phase);
            break;
    }
};
```

---

## 🧪 测试方案

### Step 1: 快速回归测试
```bash
python tests/run_regression.py
```

### Step 2: 前端视觉测试（手动）
```bash
# 启动后端
python backend/main.py

# 打开浏览器
http://localhost:8000/
```

**验证清单**:
- [ ] 能看到办公室场景
- [ ] 5个Agent显示在正确位置
- [ ] F12控制台无错误

### Step 3: 实际工作流测试
```bash
# 创建测试项目
curl -X POST http://localhost:8000/api/project/start \
  -H "Content-Type: application/json" \
  -d '{"project_name": "test_visual", "description": "测试可视化"}'

# 观察前端：
# - Agent状态变化
# - 消息飞行动画
# - 聊天记录更新
```

---

## 📝 完成后的文档工作

### 1. 更新 platform_constitution.md
在P8-1章节记录：
- Pixi.js场景结构
- Agent精灵系统
- 消息动画系统
- P8-2需要知道的扩展点

### 2. 生成阶段报告（Level 2精简版）
150-200行报告：
- 核心实现（办公室场景、Agent系统）
- 技术决策（为什么用Pixi.js、为什么用Emoji）
- 测试验证

---

## 🚀 下一阶段预告

**P8-2阶段将实现**: 2D像素风办公室（可选增强功能）

**P8-1为P8-2准备**:
- 基础场景框架
- Agent精灵系统可扩展为像素动画
- 消息系统可增加特效

**P8-2将增加**:
- 真正的像素风Agent动画（走动、工作动作）
- 办公室装饰（桌子、电脑、植物）
- 更复杂的交互（点击Agent查看详情）
- 游戏展示区（显示生成的游戏）

---

## 💡 开发提示

### 时间分配建议
- Pixi.js场景搭建: 20%
- Agent精灵系统: 25%
- 消息动画系统: 25%
- 聊天记录+状态面板: 20%
- 测试和调试: 10%

### 开发顺序
1. 先搭建Pixi.js场景，显示5个静态Agent（用Emoji）
2. 实现Agent状态变化（颜色）
3. 实现消息飞行动画（简单直线）
4. 实现聊天记录窗口
5. 集成WebSocket，测试实时性

### 常见问题FAQ

**Q: Pixi.js性能如何？**
A: 非常好。5个Agent + 少量动画完全不会卡顿。

**Q: 为什么P8-1用Emoji而不是像素图？**
A: Emoji无需美术资源，快速实现。P8-2再用像素图。

**Q: 如果浏览器不支持Pixi.js？**
A: 现代浏览器都支持。可以降级到Canvas 2D（P8-2考虑）。

---

**指引版本**: v1.0  
**最后更新**: 2026-02-11  
**预计工作量**: 10-12轮对话
