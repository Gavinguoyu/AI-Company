# P9 阶段开发指引 - 美术集成

> **阶段名称**: P9 - 美术集成  
> **预计复杂度**: 低  
> **文档级别**: Level 1 (只更新constitution，不生成独立报告)  
> **使用说明**: AI开始P9开发时，只需阅读本文档 + platform_constitution.md

---

## 🎯 阶段目标

为AI游戏开发公司添加真正的AI绘图能力：
1. **集成Gemini 2.5 Flash Image（Nano Banana）** - 调用Google Gemini的图片生成API，复用已有的GOOGLE_API_KEY
2. **美术Agent增强** - 让美术Agent能根据策划需求生成游戏素材
3. **图片后处理** - 裁剪、缩放、格式转换等

这样生成的游戏将包含AI画的真实图片，而不是色块占位符。

---

## 📋 核心任务清单

### 必须完成的功能

- [ ] **图片生成工具** (`backend/tools/image_gen_tool.py`)
  - 封装Gemini 2.5 Flash Image API调用（使用`google-genai` SDK）
  - 根据文本描述生成图片
  - 保存图片到项目目录
  - 记录生成的图片信息

- [ ] **美术Agent升级** (`backend/agents/artist_agent.py`)
  - 读取策划文档中的美术需求
  - 根据需求生成精确的绘图Prompt
  - 调用图片生成工具
  - 验证生成的图片符合规范

- [ ] **图片后处理**（可选）
  - 裁剪到指定尺寸
  - 格式转换（PNG/JPEG）
  - 压缩优化

### 可选功能（时间充裕时）
- [ ] 图片质量验证（使用Gemini Vision检查，可复用同一API）
- [ ] 批量生成和重试机制
- [ ] 图片缓存（相同描述不重复生成）

---

## 🔗 前置依赖

### P3阶段已提供的工具系统

**工具注册机制**:
- `ToolRegistry` - 全局工具管理
- `AgentToolkit` - Agent工具包

**需要做的**:
- 创建 `ImageGenTool` 并注册
- 在美术Agent中启用这个工具

### Gemini API配置（复用已有配置）

**无需额外配置**:
- 复用已有的 `GOOGLE_API_KEY`（`.env` 中已配置）
- 与文本生成（gemini-2.5-flash）共用同一个API Key
- 可选：每张图片成本预算控制

**API信息**:
- SDK: `google-genai`（新版SDK，注意不是旧版`google-generativeai`）
- 模型: `gemini-2.5-flash-image`（Nano Banana）
- 价格: ~$0.039/张（约1,290 tokens/张，远低于DALL-E 3）
- 输入: Text $0.30/M tokens | Image $0.30/M tokens
- 输出: Text $2.50/M tokens | Image $0.039/张

---

## ✅ 验证标准

### 功能验证
- [ ] 美术Agent能生成Prompt
- [ ] Gemini 2.5 Flash Image API调用成功
- [ ] 图片保存到正确位置
- [ ] art_asset_list.yaml正确更新

### 集成验证
- [ ] 不影响P8的完整流程
- [ ] 工作流中美术阶段能正常生成图片

### 简单测试
```bash
# 手动测试美术工具
python -c "
from backend.tools.image_gen_tool import ImageGenTool
tool = ImageGenTool()
await tool.generate('a cute pixel art snake character')
"
```

---

## 🛠️ 推荐使用的Skills

- `python-design-patterns` - 工具封装模式
- `async-python-patterns` - 异步API调用

---

## 📐 技术要点

### 关键技术点1: Gemini 2.5 Flash Image 集成

> **重要**: 使用新版 `google-genai` SDK（不是旧版 `google-generativeai`）。
> 需要安装: `pip install google-genai`
> 复用已有的 `GOOGLE_API_KEY`，无需额外申请API Key。

```python
# backend/tools/image_gen_tool.py
from google import genai
from google.genai import types
from PIL import Image
from pathlib import Path
import asyncio
import logging

logger = logging.getLogger(__name__)

class ImageGenTool:
    """AI图片生成工具（Gemini 2.5 Flash Image / Nano Banana）"""
    
    def __init__(self):
        # 复用已有的 GOOGLE_API_KEY
        self.client = genai.Client(api_key=Config.GOOGLE_API_KEY)
        self.model = "gemini-2.5-flash-image"
    
    async def generate(
        self,
        prompt: str,
        aspect_ratio: str = "1:1",
        save_path: Path = None
    ) -> dict:
        """
        生成图片
        
        Args:
            prompt: 图片描述（英文效果最佳）
            aspect_ratio: 宽高比（"1:1", "3:4", "4:3", "9:16", "16:9"）
            save_path: 保存路径
        
        Returns:
            {
                "path": "本地保存路径",
                "prompt": "使用的Prompt",
                "has_text": "是否包含文本回复"
            }
        """
        logger.info(f"生成图片: {prompt[:50]}...")
        
        # 调用 Gemini 2.5 Flash Image（同步调用，用asyncio.to_thread包装）
        response = await asyncio.to_thread(
            self.client.models.generate_content,
            model=self.model,
            contents=[prompt],
            config=types.GenerateContentConfig(
                response_modalities=['TEXT', 'IMAGE'],
                image_config=types.ImageConfig(
                    aspect_ratio=aspect_ratio,
                ),
            ),
        )
        
        result = {
            "path": None,
            "prompt": prompt,
            "has_text": False
        }
        
        # 解析响应（可能包含文本+图片）
        for part in response.parts:
            if part.text is not None:
                result["has_text"] = True
                result["text"] = part.text
            elif part.inline_data is not None:
                # 获取图片数据并保存
                image = part.as_image()  # 返回PIL Image对象
                if save_path:
                    save_path = Path(save_path)
                    save_path.parent.mkdir(parents=True, exist_ok=True)
                    image.save(str(save_path))
                    result["path"] = str(save_path)
                    logger.info(f"图片已保存: {save_path}")
        
        return result
```

### 关键技术点2: 美术Agent生成精确Prompt

```python
# backend/agents/artist_agent.py
class ArtistAgent(Agent):
    async def create_game_asset(self, asset_spec: dict) -> dict:
        """
        根据策划需求生成游戏素材
        
        Args:
            asset_spec: {
                "name": "snake_character",
                "description": "蛇角色，像素风格",
                "size": "64x64",
                "style": "pixel art"
            }
        """
        # 1. 使用LLM生成精确的英文Prompt（复用同一个Gemini API）
        prompt_generation = await self.llm_client.generate([
            {
                "role": "user",
                "content": f"""
你是专业的AI绘画Prompt工程师。
根据以下游戏素材需求，生成一个精确的Gemini Image Generation Prompt（英文）：

需求：
- 名称: {asset_spec['name']}
- 描述: {asset_spec['description']}
- 风格: {asset_spec.get('style', 'game art')}
- 用途: 游戏素材

要求：
1. Prompt必须是英文
2. 描述要具体、清晰
3. 包含风格关键词（如pixel art, game asset, transparent background等）
4. 适合游戏素材，背景简洁
5. Gemini擅长文字渲染，如需要可包含文字描述

只输出Prompt，不要其他内容。
"""
            }
        ])
        
        image_prompt = prompt_generation.strip()
        logger.info(f"生成的Prompt: {image_prompt}")
        
        # 2. 调用图片生成工具（Gemini 2.5 Flash Image）
        result = await self.call_tool(
            "image_gen",
            "generate",
            prompt=image_prompt,
            aspect_ratio="1:1",  # 游戏素材通常用正方形
            save_path=Path(f"projects/{project_id}/output/assets/{asset_spec['name']}.png")
        )
        
        return result
```

### 关键技术点3: 第一版可以极简

**可选项**:
- ❌ 不需要复杂的图片后处理（裁剪、滤镜等）
- ❌ 不需要风格一致性检查（第一版允许风格不完全统一）
- ❌ 不需要质量评分（Gemini Vision检查，但可复用同一API后续添加）

**必需项**:
- ✅ 能成功调用 Gemini 2.5 Flash Image
- ✅ 图片保存到正确位置
- ✅ 记录到art_asset_list.yaml

### 关键技术点4: API Key复用说明

**已有配置**（无需修改）:
- `.env` 中的 `GOOGLE_API_KEY` 同时支持文本生成和图片生成
- 文本生成: `gemini-2.5-flash`（LLM对话用）
- 图片生成: `gemini-2.5-flash-image`（美术素材用）
- 两者共用同一个API Key，只是模型名不同

**SDK注意事项**:
- 图片生成推荐使用新版 `google-genai` SDK（`from google import genai`）
- 项目中已有的 `google-generativeai`（`import google.generativeai as genai`）是旧版
- 两个SDK可以共存，图片生成工具使用新SDK，其他部分暂时保持不变
- 未来可统一迁移到新版SDK（P10或之后的技术债清理）

---

## 🧪 测试方案（自动执行）

### Step 1: 快速回归测试
```bash
python tests/run_regression.py
```

### Step 2: 美术工具单元测试
```python
# test_p9_image_gen.py
async def test_image_generation():
    tool = ImageGenTool()
    result = await tool.generate(
        prompt="a simple pixel art apple, game asset, clean background",
        aspect_ratio="1:1",
        save_path=Path("test_output/apple.png")
    )
    assert Path("test_output/apple.png").exists()
    print("✅ Gemini图片生成成功")
```

### Step 3: 集成测试（可选）
运行一个完整的游戏项目，验证美术阶段能生成图片

### Step 4: 记录结果
只更新constitution，不生成独立报告

---

## 📝 完成后的文档工作（自动执行）

### 1. 更新 platform_constitution.md（必做）
在P9章节简要记录：
```markdown
## P9: 美术集成

> 状态: ✅ 已完成 (日期)

### 核心实现
- `ImageGenTool` (`tools/image_gen_tool.py`) - Gemini 2.5 Flash Image（Nano Banana）封装
- 使用 `google-genai` 新版SDK
- 复用 `GOOGLE_API_KEY`，与文本生成共用
- 美术Agent升级（能生成Prompt并调用工具）

### 关键接口
```python
async def generate(prompt, aspect_ratio, save_path) -> dict
```

### 测试验证
✅ Gemini 2.5 Flash Image API调用成功
✅ 图片保存正确
✅ 集成到工作流

### 下一阶段集成点
P10优化时可以增强美术质量控制
```

### 2. 不生成独立阶段报告
P9功能相对简单，信息都记录在constitution中即可

---

## 🚀 下一阶段预告

**P10阶段将实现**: 优化完善（性能优化、体验优化、成本优化）

**本阶段需要为P10准备**:
- 记录美术生成的成本和耗时
- 提供优化建议（如Prompt缓存、图片复用等）

---

## 💡 开发提示

### 时间分配建议
- 图片生成工具实现: 40%
- 美术Agent集成: 40%
- 测试验证: 20%

### API密钥配置
无需额外配置！复用 `.env` 中已有的：
```env
GOOGLE_API_KEY=your_google_gemini_api_key_here  # 已配置，文本和图片生成共用
```

### 依赖安装
需要安装新版SDK（与旧版可共存）：
```bash
pip install google-genai Pillow
```

### 成本控制
- Gemini 2.5 Flash Image: ~$0.039/张（约1,290 tokens）
- 远低于DALL-E 3（$0.04-$0.08/张）
- 建议：设置每个项目的图片数量上限（如20张）

### 常见问题FAQ

**Q: 需要单独申请图片生成的API Key吗？**
A: 不需要。`GOOGLE_API_KEY` 同时支持 `gemini-2.5-flash`（文本）和 `gemini-2.5-flash-image`（图片），只是模型名不同。

**Q: `google-genai` 和已有的 `google-generativeai` 冲突吗？**
A: 不冲突。两个包可以共存。图片生成用新版 `from google import genai`，其他部分暂时保持旧版 `import google.generativeai as genai`。未来可统一迁移。

**Q: 生成的图片风格不统一怎么办？**
A: 在Prompt中加入统一的风格描述，如"consistent pixel art style, game asset"。P10再优化。

**Q: 图片生成失败怎么办？**
A: 捕获异常，回退到色块占位符，记录错误日志。

**Q: 支持哪些宽高比？**
A: 支持 "1:1", "2:3", "3:2", "3:4", "4:3", "4:5", "5:4", "9:16", "16:9"。游戏素材推荐 "1:1"。

---

**指引版本**: v1.1  
**最后更新**: 2026-02-12  
**变更记录**: v1.1 - 将美术API从DALL-E 3（OpenAI）改为Gemini 2.5 Flash Image / Nano Banana（Google），复用已有GOOGLE_API_KEY  
**预计工作量**: 3-5轮对话
