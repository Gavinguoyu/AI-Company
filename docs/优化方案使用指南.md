# Token优化方案使用指南

> **创建日期**: 2026-02-11  
> **目标**: 节省66% Token消耗，同时保持开发质量  
> **适用范围**: P6-P10阶段

---

## 🎯 优化方案概述

### 问题背景
从P0开始到P5完成，Token消耗从28%增长到90%（增长62%），如果按原方案继续开发P6-P10，预计会超出100%限额。

### 优化目标
- 节省Token消耗66%（P6-P10五个阶段从90万降至30万）
- 保持开发质量不下降
- 不增加用户操作复杂度

### 三大优化措施

1. **文档加载优化** - 节省55%
   - 创建精简的阶段指引文档（200-300行）
   - 替代完整开发计划（1600行）
   
2. **测试流程优化** - 节省80%
   - 增量测试（只测新功能）
   - 测试脚本模板化
   - 回归测试自动化

3. **报告生成优化** - 节省68%
   - 分级文档策略（Level 1/2/3）
   - 精简报告模板（删除冗余章节）
   - 简单阶段不生成独立报告

---

## 📁 新增文件结构

```
d:\Cursor\AI-Company\
├── docs\
│   ├── 开发流程总控.md                # 总控文档（AI参考）
│   ├── 优化方案使用指南.md            # 本文档（用户参考）
│   │
│   ├── templates\                    # 模板目录
│   │   ├── stage_guide_template.md   # 阶段指引模板
│   │   ├── test_template.md          # 测试脚本模板
│   │   └── report_template.md        # 报告生成模板
│   │
│   └── stage_guides\                 # 阶段指引目录
│       ├── P6_指引.md                # P6: 前端可视化
│       ├── P7_指引.md                # P7: 人类介入
│       ├── P8_指引.md                # P8: 联调测试
│       ├── P9_指引.md                # P9: 美术集成
│       └── P10_指引.md               # P10: 优化完善
│
└── tests\
    └── run_regression.py             # 回归测试运行器
```

---

## 🚀 使用方法

### 用户操作（极简版）

#### 开始新阶段开发

只需一句话：

```
请阅读 docs/stage_guides/P6_指引.md，并开始开发P6阶段
```

AI会自动：
1. 读取P6指引和constitution（~3.5万tokens）
2. 实现代码
3. 生成测试脚本
4. 提示你运行测试
5. 根据文档级别生成报告或只更新constitution
6. 汇报完成

#### 运行回归测试

当AI提示时运行：

```bash
python tests/run_regression.py
```

看到 ✅ 表示所有关键功能正常

#### 运行阶段测试

当AI生成测试脚本后运行：

```bash
python test_p6.py  # 替换为对应阶段
```

### 完整示例（P6阶段）

```
【对话1】
你: 请阅读 docs/stage_guides/P6_指引.md，并开始开发P6阶段

AI: (读取文档...)
    (开始实现前端代码...)
    (20分钟后)
    ✅ 代码实现完成，共实现了5个模块...
    
    现在生成测试脚本...
    ✅ 已生成 test_p6_frontend.py
    
    请先运行回归测试:
    python tests/run_regression.py

【你运行回归测试】
$ python tests/run_regression.py
✅ P1-LLM客户端基础
✅ P2-消息总线路由
✅ P3-文件工具读写
✅ P4-工作流初始化
✅ P5-API健康检查
🎉 所有回归测试通过！

【对话2】
你: 回归测试通过

AI: 很好！现在请运行P6阶段测试:
    python test_p6_frontend.py

【你运行P6测试】
$ python test_p6_frontend.py
✅ 模块导入
✅ WebSocket连接
✅ 消息显示
✅ 状态面板
✅ 文件浏览器
🎉 所有测试通过！

【对话3】
你: 测试全部通过

AI: 🎉 太好了！正在更新文档...
    
    ✅ 已更新 platform_constitution.md 的P6章节
    ✅ 已生成 P6_阶段完成报告.md (Level 2精简版)
    
    📊 P6阶段完成情况:
    - 实现功能: WebSocket客户端、办公室视图、对话面板、状态面板、文件浏览器
    - 测试通过: 5/5 (100%)
    - 文档更新: ✅
    
    🚀 下一步建议:
    开始P7阶段开发
    使用命令: "请阅读 docs/stage_guides/P7_指引.md，并开始开发P7阶段"
```

---

## 📊 Token消耗对比

### 单个阶段（以P6为例）

| 环节 | 原方案 | 优化方案 | 节省 |
|------|--------|---------|------|
| **文档加载** | 8万 | 3.5万 | 56% ⬇️ |
| **代码开发** | 2-3万 | 2-3万 | 0% |
| **测试生成** | 5万 | 1万 | 80% ⬇️ |
| **报告生成** | 5万 | 1.5万 | 70% ⬇️ |
| **总计** | ~20万 | ~8万 | **60%** ✨ |

### P6-P10五个阶段总计

| 项目 | 原方案 | 优化方案 | 节省 |
|------|--------|---------|------|
| **文档加载** | 40万 | 17.5万 | 56% |
| **测试** | 25万 | 5万 | 80% |
| **报告** | 25万 | 8万 | 68% |
| **总计** | **90万** | **30.5万** | **66%** ✨ |

---

## 📋 各阶段文档级别

### Level 1: 极简记录（不生成独立报告）

**适用阶段**: P7, P9

**Token消耗**: ~3.5万/阶段

**文档产出**:
- 只更新 `platform_constitution.md`
- 记录核心接口和集成要点
- 不生成独立的阶段完成报告

**示例**: 
```markdown
## P7: 人类介入机制

> 状态: ✅ 已完成

### 核心实现
- 决策等待机制
- 前端决策面板

### 关键接口
```python
async def _request_boss_decision(...) -> str
```

### 测试验证
✅ 决策流程正常
```

---

### Level 2: 精简报告（推荐）

**适用阶段**: P6, P10

**Token消耗**: ~7-8万/阶段

**文档产出**:
- 更新 `platform_constitution.md`
- 生成150-200行精简报告
- 只包含5个核心章节：
  1. 核心实现
  2. 集成要点
  3. 设计决策
  4. 测试验证
  5. 完成标志

**删除的章节**:
- ❌ 代码统计
- ❌ 技术亮点（单独章节）
- ❌ 详细测试输出
- ❌ 经验总结

---

### Level 3: 详细报告

**适用阶段**: P8（联调测试）

**Token消耗**: ~10万

**文档产出**:
- 更新 `platform_constitution.md`
- 生成400-500行详细报告
- 包含所有章节（关键里程碑，保留完整信息）

---

## ⚙️ 配置和定制

### 调整文档级别

如果你想改变某个阶段的文档级别，修改对应的指引文件：

```markdown
# docs/stage_guides/P7_指引.md

> **文档级别**: Level 2 (改为精简报告)
```

然后告诉AI：
```
请按照Level 2标准生成报告
```

### 添加自定义测试

在 `tests/run_regression.py` 中添加：

```python
TESTS = [
    # ... existing tests ...
    ("P6-自定义测试", "test_p6.py", "test_custom_feature"),
]
```

### 定制报告模板

编辑 `docs/templates/report_template.md`，按需调整章节和内容。

---

## ❓ 常见问题

### Q1: 是否必须运行回归测试？

**A**: 强烈建议运行，但如果时间紧张可以跳过。回归测试能快速发现新代码是否破坏了旧功能。

### Q2: 测试失败了怎么办？

**A**: 将错误信息复制给AI：
```
测试失败，错误信息：
[粘贴错误日志]

请分析并修复
```

### Q3: 能否跳过某个阶段？

**A**: 可以，但不建议。如果确实要跳过（如P9美术集成），可以：
```
请跳过P9阶段，直接开始P10
```

### Q4: 生成的报告太简单怎么办？

**A**: 可以要求AI生成更详细的报告：
```
请按照Level 3标准（详细报告）生成P6报告
```

### Q5: 回归测试越来越慢怎么办？

**A**: 回归测试只保留关键测试，每个阶段1-2个即可。如果超过10个，考虑删除一些不太重要的。

### Q6: 优化方案适用于其他项目吗？

**A**: 核心思路适用，但需要根据项目特点调整：
- 文档精简策略
- 测试模板结构
- 报告级别划分

---

## 📈 效果监控

### 如何判断优化是否成功？

观察以下指标：

1. **Token使用率**
   - P6完成后应在92-95%
   - P8完成后应在97-99%
   - P10完成后应≤100%

2. **单阶段Token消耗**
   - Level 1阶段: 3-4万
   - Level 2阶段: 7-8万
   - Level 3阶段: 9-11万

3. **开发质量**
   - 测试通过率 ≥95%
   - 无阻塞性Bug
   - 文档完整可查阅

### 如果Token仍然紧张

可以进一步优化：
1. 更激进地精简报告（所有阶段都用Level 1）
2. 减少代码示例
3. 合并P6-P7的报告
4. 延后P9（美术集成）到项目完成后

---

## ✅ 验收标准

### 优化方案成功的标志

- ✅ P6-P10五个阶段在Token限额内完成
- ✅ 所有关键功能正常工作
- ✅ Platform constitution记录完整
- ✅ 能顺利演示完整流程
- ✅ 用户体验良好

### 最终目标

**项目完成时的状态**:
- Token使用: ≤100%
- 代码行数: 约4000-5000行
- 文档: constitution + 3-5份阶段报告
- 测试: 回归测试 + 阶段测试全部通过
- 产出: 可演示的AI游戏开发平台

---

## 🔄 持续改进

### 反馈和优化

如果在使用中发现问题，记录下来：

**问题类型**:
- 指引不够清晰 → 更新stage_guides
- 测试模板不合理 → 更新test_template.md
- 报告太简略/冗长 → 调整文档级别或模板

**改进流程**:
1. 记录问题（what, when, why）
2. 提出改进方案
3. 更新对应模板
4. 在后续阶段验证

---

## 📚 相关文档

- `docs/开发流程总控.md` - AI开发流程详解
- `docs/platform_constitution.md` - 项目架构和已完成内容
- `docs/开发计划.md` - 完整开发计划（参考用）
- `docs/templates/` - 所有模板文件

---

**文档版本**: v1.0  
**最后更新**: 2026-02-11  
**适用版本**: P6-P10  
**预期效果**: 节省66% Token，保持高质量开发

---

## 🎉 开始使用

现在就可以开始P6阶段开发了！

只需说：
```
请阅读 docs/stage_guides/P6_指引.md，并开始开发P6阶段
```

祝开发顺利！🚀
